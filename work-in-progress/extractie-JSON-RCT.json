{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.org/schemas/extraction.schema.json",
  "title": "Clinical Trial Extraction (RCT)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "metadata",
    "study_design",
    "population",
    "arms",
    "outcomes",
    "results"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^v\\d+\\.\\d+(\\.\\d+)?$",
      "description": "Semantic-like version tag, e.g. v1.0 or v1.2.3"
    },
    "document": {
      "type": "object",
      "additionalProperties": false,
      "required": ["filename", "page_count"],
      "properties": {
        "filename": { "type": "string" },
        "content_type": {
          "type": "string",
          "enum": ["application/pdf"],
          "default": "application/pdf"
        },
        "size_bytes": { "type": "integer", "minimum": 0 },
        "page_count": { "type": "integer", "minimum": 1 }
      }
    },
    "study_id": {
      "type": "string",
      "pattern": "^[A-Za-z0-9._-]+$",
      "description": "Internal opaque ID for this study/article"
    },
    "generator": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "model", "timestamp"],
      "properties": {
        "name": { "type": "string" },
        "model": { "type": "string" },
        "temperature": { "type": "number" },
        "timestamp": { "type": "string", "format": "date-time" }
      }
    },
    "language": {
      "type": "string",
      "pattern": "^[a-z]{2}$",
      "description": "ISO 639-1 code (e.g., 'en', 'nl')"
    },
    "metadata": { "$ref": "#/$defs/Metadata" },
    "study_design": { "$ref": "#/$defs/StudyDesign" },
    "population": { "$ref": "#/$defs/Population" },
    "interventions": {
      "type": "array",
      "description": "Optional free-text procedural details per arm; link via arm_id.",
      "items": { "$ref": "#/$defs/Intervention" },
      "default": []
    },
    "arms": {
      "type": "array",
      "items": { "$ref": "#/$defs/Arm" },
      "minItems": 1,
      "uniqueItems": true
    },
    "comparisons": {
      "type": "array",
      "items": { "$ref": "#/$defs/Comparison" },
      "default": []
    },
    "outcomes": {
      "type": "array",
      "items": { "$ref": "#/$defs/Outcome" },
      "minItems": 1,
      "uniqueItems": false
    },
    "results": { "$ref": "#/$defs/Results" },
    "tables_parsed": {
      "type": "array",
      "items": { "$ref": "#/$defs/ParsedTable" },
      "default": []
    },
    "figures_summary": {
      "type": "array",
      "items": { "$ref": "#/$defs/FigureSummary" },
      "default": []
    },
    "risk_of_bias": { "$ref": "#/$defs/RiskOfBias" },
    "protocol_deviations": { "type": "string" },
    "extraction_warnings": {
      "type": "array",
      "items": { "$ref": "#/$defs/ExtractionWarning" },
      "default": []
    },
    "truncated": { "$ref": "#/$defs/TruncationInfo" }
  },
  "$defs": {
    "SourceRef": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "anchor": {
          "type": "string",
          "description": "Free-text pointer like 'Table 2', 'Fig 1', or sentence quote"
        },
        "page": { "type": "integer", "minimum": 1 },
        "figure_id": { "type": "string" },
        "table_id": { "type": "string" }
      }
    },
    "Author": {
      "type": "object",
      "additionalProperties": false,
      "required": ["last_name"],
      "properties": {
        "last_name": { "type": "string" },
        "initials": { "type": "string" },
        "given_names": { "type": "string" },
        "orcid": { "type": "string", "pattern": "^\\d{4}-\\d{4}-\\d{4}-\\d{3}[\\dX]$" },
        "affiliations": {
          "type": "array",
          "items": { "type": "string" },
          "default": []
        },
        "corresponding": { "type": "boolean", "default": false }
      }
    },
    "Registration": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "registry": {
          "type": "string",
          "enum": [
            "ClinicalTrials.gov",
            "ISRCTN",
            "EudraCT",
            "ChiCTR",
            "ANZCTR",
            "Other",
            "EU-CTR",
            "CTIS"
          ]
        },
        "identifier": { "type": "string" },
        "url": { "type": "string", "format": "uri" }
      }
    },
    "Metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": ["title", "journal"],
      "properties": {
        "title": { "type": "string" },
        "journal": { "type": "string" },
        "journal_abbrev": { "type": "string" },
        "published_date": { "type": "string", "format": "date" },
        "published_date_precision": {
          "type": "string",
          "enum": ["year", "month", "day"]
        },
        "volume": { "type": "string" },
        "issue": { "type": "string" },
        "pages": { "type": "string" },
        "page_start": { "type": "string" },
        "page_end": { "type": "string" },
        "article_number": { "type": "string" },
        "elocation_id": { "type": "string" },
        "issn": { "type": "string", "pattern": "^(\\d{4}-\\d{3}[\\dxX])$" },
        "eissn": { "type": "string", "pattern": "^(\\d{4}-\\d{3}[\\dxX])$" },
        "authors": {
          "type": "array",
          "items": { "$ref": "#/$defs/Author" },
          "default": []
        },
        "pmid": { "type": "string", "pattern": "^\\d{1,8}$" },
        "pmcid": { "type": "string", "pattern": "^PMC\\d+$" },
        "doi": {
          "type": "string",
          "pattern": "^10\\.\\d{4,9}/[-._;()/:A-Za-z0-9]+$",
          "description": "DOI; patroon accepteert hoofd- en kleine letters"
        },
        "registration": { "$ref": "#/$defs/Registration" },
        "protocol_ref": { "type": "string" },
        "funding": { "type": "string" },
        "conflict_of_interest": { "type": "string" },
        "epub_ahead_of_print_date": { "type": "string" },
        "vancouver_citation": { "type": "string" },
        "vancouver_source": { "$ref": "#/$defs/SourceRef" },
        "source": { "$ref": "#/$defs/SourceRef" }
      }
    },
    "StudyDesign": {
      "type": "object",
      "additionalProperties": false,
      "required": ["label"],
      "properties": {
        "label": { "type": "string", "enum": ["RCT"] },
        "ethics_approval": { "type": "string" },
        "consent_obtained": { "type": "string", "enum": ["yes", "no", "unclear"] },
        "population_context": {
          "type": "string",
          "enum": ["adult", "pediatric", "mixed", "unclear"]
        },
        "design_details": { "type": "string" },
        "centres": { "type": "integer", "minimum": 1 },
        "countries": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[A-Z]{2}$",
            "description": "ISO 3166-1 alpha-2 country code"
          },
          "default": []
        },
        "setting": { "type": "string" },
        "randomisation": {
          "type": "string",
          "enum": [
            "individual",
            "cluster",
            "blocked",
            "stratified",
            "minimisation",
            "none",
            "unclear"
          ]
        },
        "allocation_concealment": {
          "type": "string",
          "enum": ["adequate", "inadequate", "unclear"]
        },
        "blinding": {
          "type": "string",
          "enum": ["open-label", "single-blind", "double-blind", "triple-blind", "unclear"]
        },
        "analysis_population": {
          "type": "string",
          "enum": ["ITT", "mITT", "PP", "Safety", "Other"]
        },
        "non_inferiority_margin": { "type": "string" },
        "source": { "$ref": "#/$defs/SourceRef" },
        "crossover": { "type": "boolean", "default": false },
        "washout_period_iso8601": {
          "type": "string",
          "pattern": "^P(T)?[\\dYMWDTHMS]+$",
          "description": "ISO 8601 duur van de washout, bijv. 'P14D' of 'PT12H'"
        }
      }
    },
    "Population": {
      "type": "object",
      "additionalProperties": false,
      "required": ["n_randomised"],
      "properties": {
        "n_screened": { "type": "integer", "minimum": 0 },
        "n_randomised": { "type": "integer", "minimum": 1 },
        "n_analysed": { "type": "integer", "minimum": 0 },
        "age_mean": { "type": "number" },
        "age_sd": { "type": "number", "minimum": 0 },
        "sex_female_pct": { "type": "number", "minimum": 0, "maximum": 100 },
        "asa_distribution": { "type": "string" },
        "bmi_mean": { "type": "number" },
        "bmi_sd": { "type": "number", "minimum": 0 },
        "comorbidities_key": { "type": "string" },
        "surgery_type": { "type": "string" },
        "urgency": { "type": "string" },
        "inclusion_criteria": { "type": "string" },
        "exclusion_criteria": { "type": "string" },
        "follow_up_duration_iso8601": {
          "type": "string",
          "pattern": "^P(T)?[\\dYMWDTHMS]+$",
          "description": "ISO 8601 duration, e.g. 'P30D', 'PT24H'"
        },
        "missing_data": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "outcome_missing_pct": { "type": "number", "minimum": 0, "maximum": 100 },
            "imputation": { "type": "string" }
          }
        },
        "source": { "$ref": "#/$defs/SourceRef" }
      }
    },
    "Intervention": {
      "type": "object",
      "additionalProperties": false,
      "required": ["arm_id", "arm_label"],
      "properties": {
        "arm_id": { "type": "string" },
        "arm_label": { "type": "string" },
        "description": { "type": "string" },
        "dose_regimen": { "type": "string" },
        "route_timing": { "type": "string" },
        "co_interventions": { "type": "string" },
        "anesthesia_technique": { "type": "string" },
        "airway_management": { "type": "string" },
        "monitoring": { "type": "string" },
        "neuromuscular_block": { "type": "string" },
        "analgesia_strategy": { "type": "string" },
        "source": { "$ref": "#/$defs/SourceRef" }
      }
    },
    "Arm": {
      "type": "object",
      "additionalProperties": false,
      "required": ["arm_id", "label"],
      "properties": {
        "arm_id": { "type": "string" },
        "label": { "type": "string" },
        "n_assigned": { "type": "integer", "minimum": 0 },
        "n_analysed": { "type": "integer", "minimum": 0 },
        "description": { "type": "string" }
      }
    },
    "Comparison": {
      "type": "object",
      "additionalProperties": false,
      "required": ["comparison_id", "arm_a", "arm_b"],
      "properties": {
        "comparison_id": { "type": "string" },
        "arm_a": { "type": "string", "description": "arm_id" },
        "arm_b": { "type": "string", "description": "arm_id" },
        "is_primary": { "type": "boolean", "default": false }
      }
    },
    "Outcome": {
      "type": "object",
      "additionalProperties": false,
      "required": ["outcome_id", "name", "type"],
      "properties": {
        "outcome_id": { "type": "string" },
        "name": { "type": "string" },
        "definition": { "type": "string" },
        "type": {
          "type": "string",
          "enum": ["binary", "continuous", "time_to_event", "ordinal", "count"]
        },
        "is_primary": { "type": "boolean", "default": false },
        "direction_of_benefit": {
          "type": "string",
          "enum": ["higher_better", "lower_better", "neutral_or_na"]
        },
        "unit": { "type": "string" },
        "timepoint": { "type": "string" },
        "timepoint_iso8601": { "type": "string", "pattern": "^P(T)?[\\dYMWDTHMS]+$" },
        "measurement_method": { "type": "string" },
        "scale_min": { "type": "number" },
        "scale_max": { "type": "number" },
        "source": { "$ref": "#/$defs/SourceRef" },
        "unit_ucum": { "type": "string", "description": "UCUM code if available" }
      }
    },
    "EffectCI": {
      "type": "object",
      "additionalProperties": false,
      "required": ["lower", "upper"],
      "properties": {
        "level": { "type": "number", "enum": [90, 95, 99], "default": 95 },
        "lower": { "type": "number" },
        "upper": { "type": "number" }
      }
    },
    "ContrastEffect": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "point"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["RR", "OR", "HR", "MD", "SMD", "RD", "RMST", "Other"]
        },
        "point": { "type": "number" },
        "ci": { "$ref": "#/$defs/EffectCI" },
        "p_value": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },
    "PerArmResult": {
      "type": "object",
      "additionalProperties": false,
      "required": ["outcome_id", "arm_id"],
      "properties": {
        "outcome_id": { "type": "string" },
        "arm_id": { "type": "string" },
        "n": { "type": "integer", "minimum": 0 },
        "events": { "type": "integer", "minimum": 0 },
        "mean": { "type": "number" },
        "sd": { "type": "number", "minimum": 0 },
        "median": { "type": "number" },
        "iqr": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "p25": { "type": "number" },
            "p75": { "type": "number" }
          }
        },
        "total": { "type": "integer", "minimum": 0 },
        "unit": { "type": "string" },
        "source": { "$ref": "#/$defs/SourceRef" }
      },
      "oneOf": [
        {
          "required": ["mean", "sd"],
          "not": {
            "anyOf": [
              { "required": ["median"] },
              { "required": ["iqr"] },
              { "required": ["events"] }
            ]
          }
        },
        {
          "required": ["median", "iqr"],
          "not": {
            "anyOf": [
              { "required": ["mean"] },
              { "required": ["sd"] },
              { "required": ["events"] }
            ]
          },
          "properties": {
            "iqr": { "required": ["p25", "p75"] }
          }
        },
        {
          "description": "Binaire uitkomst per arm",
          "required": ["events"],
          "anyOf": [{ "required": ["n"] }, { "required": ["total"] }]
        }
      ]
    },
    "ContrastResult": {
      "type": "object",
      "additionalProperties": false,
      "required": ["outcome_id", "comparison_id", "effect"],
      "properties": {
        "outcome_id": { "type": "string" },
        "comparison_id": { "type": "string" },
        "population": {
          "type": "string",
          "enum": ["ITT", "mITT", "PP", "Safety", "Other"]
        },
        "adjusted": { "type": "boolean", "default": false },
        "covariates": {
          "type": "array",
          "items": { "type": "string" },
          "default": []
        },
        "model": {
          "type": "string",
          "enum": [
            "fixed",
            "random",
            "cox",
            "logistic",
            "linear",
            "poisson",
            "nb",
            "other",
            "na"
          ]
        },
        "effect": { "$ref": "#/$defs/ContrastEffect" },
        "source": { "$ref": "#/$defs/SourceRef" }
      }
    },
    "HarmsResult": {
      "type": "object",
      "additionalProperties": false,
      "required": ["event", "arm_id", "events", "total", "source"],
      "properties": {
        "event": { "type": "string" },
        "arm_id": { "type": "string" },
        "severity_grade_scale": {
          "type": "string",
          "enum": ["CTCAE", "Clavien-Dindo", "Other", "NA"]
        },
        "events": { "type": "integer", "minimum": 0 },
        "total": { "type": "integer", "minimum": 0 },
        "source": { "$ref": "#/$defs/SourceRef" },
        "serious": { "type": "boolean", "default": false },
        "relatedness": {
          "type": "string",
          "enum": ["related", "probable", "possible", "unlikely", "not_related", "unknown"],
          "default": "unknown"
        }
      }
    },
    "Results": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "per_arm": {
          "type": "array",
          "items": { "$ref": "#/$defs/PerArmResult" },
          "default": []
        },
        "contrasts": {
          "type": "array",
          "items": { "$ref": "#/$defs/ContrastResult" },
          "default": []
        },
        "harms": {
          "type": "array",
          "items": { "$ref": "#/$defs/HarmsResult" },
          "default": []
        }
      }
    },
    "ParsedTable": {
      "type": "object",
      "additionalProperties": false,
      "required": ["table_id", "title"],
      "properties": {
        "table_id": { "type": "string" },
        "title": { "type": "string" },
        "page": { "type": "integer", "minimum": 1 },
        "type": {
          "type": "string",
          "enum": ["baseline", "outcomes", "harms", "methods", "other"]
        },
        "rows": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["cells"],
            "properties": {
              "cells": {
                "type": "array",
                "minItems": 1,
                "items": { "type": "string" }
              }
            }
          },
          "default": []
        },
        "source": { "$ref": "#/$defs/SourceRef" }
      }
    },
    "FigureSummary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["figure_id", "caption"],
      "properties": {
        "figure_id": { "type": "string" },
        "caption": { "type": "string" },
        "key_values": {
          "type": "object",
          "additionalProperties": { "type": "number" },
          "default": {}
        },
        "page": { "type": "integer", "minimum": 1 },
        "source": { "$ref": "#/$defs/SourceRef" }
      }
    },
    "RiskOfBias": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "tool": { "type": "string", "enum": ["RoB2", "ROBINS-I", "Other"] },
        "overall": { "type": "string" },
        "domains": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["domain", "judgement"],
            "properties": {
              "domain": { "type": "string" },
              "judgement": {
                "type": "string",
                "enum": ["low", "some", "high", "unclear", "moderate", "serious", "critical", "no_information", "some_concerns"]
              },
              "notes": { "type": "string" }
            }
          },
          "default": []
        }
      },
      "allOf": [
        {
          "if": { "properties": { "tool": { "const": "RoB2" } } },
          "then": {
            "properties": {
              "overall": { "type": "string", "enum": ["low", "some_concerns", "high", "unclear"] },
              "domains": {
                "items": {
                  "properties": {
                    "domain": {
                      "type": "string",
                      "enum": [
                        "randomization_process",
                        "deviations_from_intended_interventions",
                        "missing_outcome_data",
                        "measurement_of_outcome",
                        "selection_of_reported_result"
                      ]
                    },
                    "judgement": { "type": "string", "enum": ["low", "some_concerns", "high", "unclear"] }
                  }
                },
                "minItems": 5
              }
            }
          }
        },
        {
          "if": { "properties": { "tool": { "const": "ROBINS-I" } } },
          "then": {
            "properties": {
              "overall": { "type": "string", "enum": ["low", "moderate", "serious", "critical", "no_information"] },
              "domains": {
                "items": {
                  "properties": {
                    "domain": {
                      "type": "string",
                      "enum": [
                        "bias_due_to_confounding",
                        "bias_in_selection_of_participants",
                        "bias_in_classification_of_interventions",
                        "bias_due_to_deviations_from_intended_interventions",
                        "bias_due_to_missing_data",
                        "bias_in_measurement_of_outcomes",
                        "bias_in_selection_of_reported_result"
                      ]
                    },
                    "judgement": { "type": "string", "enum": ["low", "moderate", "serious", "critical", "no_information"] }
                  }
                },
                "minItems": 7
              }
            }
          }
        }
      ]
    },
    "ExtractionWarning": {
      "type": "object",
      "additionalProperties": false,
      "required": ["code", "message"],
      "properties": {
        "code": {
          "type": "string",
          "enum": ["TABLE_PARSE_FAIL", "AMBIGUOUS_UNIT", "CI_PARSE_FAIL", "MISSING_ARM_ID", "OTHER"]
        },
        "message": { "type": "string" },
        "source": { "$ref": "#/$defs/SourceRef" }
      }
    },
    "TruncationInfo": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "value": { "type": "boolean", "default": false },
        "reason": { "type": "string", "enum": ["token_limit", "page_limit", "timeout", "other"] }
      }
    }
  }
}
