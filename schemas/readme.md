# Schema Library

The `schemas/` directory contains JSON Schema files that define the structured outputs expected from each pipeline stage. Every extraction prompt has a matching schema to guarantee that LLM responses can be validated deterministically.

- Modular schema sources live alongside a shared `common.schema.json`.
- Bundled schemas (`*_bundled.json`) are generated by inlining shared definitions so they can be distributed without external references.
- Tests asserting schema validity are located in `tests/unit/test_schemas.py`.

## Inventory

| Study type / stage        | Bundled schema file                  | Modular sources                              | Typical use                         |
|---------------------------|--------------------------------------|----------------------------------------------|-------------------------------------|
| Classification metadata   | `classification_bundled.json`        | `classification.schema.json`                 | Publication type detection          |
| Interventional trials     | `interventional_trial_bundled.json`  | `interventional_trial.schema.json`           | RCTs, cluster and crossover trials  |
| Observational analytic    | `observational_analytic_bundled.json`| `observational_analytic.schema.json`         | Cohort, case-control, cross-sectional |
| Evidence synthesis        | `evidence_synthesis_bundled.json`    | `evidence_synthesis.schema.json`             | Systematic reviews, meta-analyses   |
| Prediction & prognosis    | `prediction_prognosis_bundled.json`  | `prediction_prognosis.schema.json`           | Risk prediction, prognostic models  |
| Editorials & opinion      | `editorials_opinion_bundled.json`    | `editorials_opinion.schema.json`             | Editorials, commentaries            |
| Validation reports        | `validation_bundled.json`            | `validation.schema.json`                     | LLM quality assessment output       |

If classification returns `overig`, no extraction schema is applied.

## Validating extracted JSON

```python
import json
from pathlib import Path
from jsonschema import validate

schema = json.loads(Path("schemas/interventional_trial_bundled.json").read_text())
data = json.loads(Path("tmp/paper-extraction0.json").read_text())

validate(instance=data, schema=schema)
```

Bundled schemas are self-contained and recommended for runtime validation. Modular schemas are easier to inspect during development when cross-references are desirable.

## Bundling modular schemas

`json-bundler.py` combines modular schemas with shared definitions:

```bash
cd schemas
python json-bundler.py
```

Output files (for example, `interventional_trial_bundled.json`) are overwritten in place. Run the bundler whenever modular sources change, then commit both modular and bundled artefacts.

## Maintenance checklist

1. **Keep prompts aligned** - field names defined here must match the extraction prompts in `prompts/`.
2. **Regenerate bundles** - after editing any `*.schema.json` file, run `python json-bundler.py`.
3. **Run schema tests** - execute `pytest tests/unit/test_schemas.py` (or `make test-fast`) to ensure schemas remain valid.
4. **Version awareness** - update the metadata block in each schema when structural changes are introduced.
5. **Document breaking changes** - capture schema updates in `CHANGELOG.md` and adjust fixtures under `tests/fixtures/expected_outputs/` if required.

## JSON Schema features used

- Draft 2020-12 (`$schema` field) with `$defs` for shared components.
- Reusable definitions in `common.schema.json` (e.g., contact info, outcome measures).
- Enumerations for publication types, measurement units, and study designs.
- Format constraints for identifiers (DOI, registry IDs).
- Conditional logic for mutually exclusive arms vs. contrasts.

## Standards alignment

Schemas reflect widely adopted reporting checklists:

| Domain                  | Primary references                          |
|-------------------------|---------------------------------------------|
| Interventional          | CONSORT 2010, ICH-GCP, RoB 2.0              |
| Observational           | STROBE, ROBINS-I, GRADE                     |
| Evidence synthesis      | PRISMA 2020, AMSTAR-2                       |
| Prediction/prognosis    | TRIPOD, TRIPOD-AI, PROBAST                  |
| Validation reporting    | Adapts issues from RoB 2.0 / ROBINS-I style |

## Related documentation

- `../prompts/README.md` - prompt templates tied to these schemas.
- `../VALIDATION_STRATEGY.md` - how validation reports use `validation_bundled.json`.
- `../ARCHITECTURE.md` - pipeline design and schema integration.
- `../README.md` - top-level setup instructions.
